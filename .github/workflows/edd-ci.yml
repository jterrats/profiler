name: EDD CI Pipeline

# Optimized for GitHub Actions Free Tier
# Philosophy: Run error tests first (cheap), full tests only when needed
# Architecture: Main workflow that orchestrates all testing (calls tests.yml and e2e.yml)

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md" # Skip docs-only changes
      - "docs/**"
      - "LICENSE"
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs when new commit pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Tier 1: Fast checks (runs always, ~2-3 min)
  quick-check:
    name: Lint & Error Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Fast: Linting (catches simple errors)
      - name: Lint
        run: yarn lint

      # Fast: Type checking (catches type errors)
      - name: Type Check
        run: yarn tsc --noEmit

      # EDD Core: Run error tests FIRST
      # These tests are designed to be fast and comprehensive
      - name: Run Error Tests
        run: |
          echo "ðŸš¨ Running Error-Driven Development Tests..."
          yarn test:errors --maxWorkers=2
        env:
          NODE_ENV: test

      # If error tests pass, we have confidence in error handling
      - name: âœ… Error Tests Passed
        if: success()
        run: echo "All error scenarios properly handled!"

  # Tier 2: Official Salesforce CLI tests (runs on PRs, ~7 min)
  # Calls the reusable tests workflow (unit-tests, nuts, macOS)
  official-tests:
    name: Unit & Integration Tests
    needs: quick-check
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/test.yml
    secrets: inherit

  # Tier 3: E2E Tests (runs on PRs, ~10-15 min)
  # Calls the e2e.yml workflow with real Salesforce org
  e2e-tests:
    name: End-to-End Tests
    needs: official-tests
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/e2e.yml
    secrets:
      SF_AUTH_URL_E2E_ORG: ${{ secrets.SF_AUTH_URL_E2E_ORG }}

  # Build check on push to main/develop (calls official tests which include macOS build)
  build-check:
    name: Build Check
    needs: quick-check
    if: github.event_name == 'push'
    uses: ./.github/workflows/test.yml
    secrets: inherit
