name: tests

# Reusable workflow for official Salesforce CLI tests
# Can be called by edd-ci.yml or triggered manually
# Executes: unit-tests (Linux/Windows), macOS build check, NUT tests, E2E (optional)

on:
  # Can be called by other workflows (like edd-ci.yml)
  workflow_call:
    inputs:
      run_e2e:
        description: "Run E2E tests with real org (requires SF_AUTH_URL_E2E_ORG secret)"
        required: false
        type: boolean
        default: false
    secrets:
      SF_AUTH_URL_E2E_ORG:
        required: false
  # Can also be triggered manually for testing
  workflow_dispatch:
    inputs:
      run_e2e:
        description: "Run E2E tests with real org (requires SF_AUTH_URL_E2E_ORG secret)"
        required: false
        type: boolean
        default: false

jobs:
  unit-tests:
    uses: salesforcecli/github-workflows/.github/workflows/unitTest.yml@main

  # macOS build validation (build + basic tests)
  macos-build-check:
    name: macOS Build & Test Validation
    runs-on: macos-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build plugin
        run: yarn build

      - name: Run unit tests
        run: yarn test

  nuts:
    needs: [unit-tests, macos-build-check]
    uses: salesforcecli/github-workflows/.github/workflows/nut.yml@main
    secrets: inherit
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
      fail-fast: false
    with:
      os: ${{ matrix.os }}

  # E2E tests with real Salesforce org (optional)
  # Only runs when manually triggered with run_e2e=true
  e2e:
    needs: nuts
    if: github.event.inputs.run_e2e == 'true'
    uses: ./.github/workflows/e2e.yml
    secrets:
      SF_AUTH_URL_E2E_ORG: ${{ secrets.SF_AUTH_URL_E2E_ORG }}
