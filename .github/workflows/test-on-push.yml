name: Test Plugin on Push

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'examples/**'
      - 'LICENSE*'
      - '.gitignore'
      - '.npmignore'

jobs:
  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18.x, 20.x]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Compile TypeScript
        run: yarn build

      - name: Run linting
        run: yarn lint

      - name: Run unit tests
        run: yarn test:only

      - name: Check for compilation errors
        run: |
          if [ -d "lib" ]; then
            echo "✓ Compilation successful - lib directory exists"
            ls -la lib/commands/profiler/
          else
            echo "✗ Compilation failed - lib directory missing"
            exit 1
          fi
        shell: bash

  test-plugin-linking:
    name: Test Plugin Installation
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'yarn'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli

      - name: Install dependencies and build
        run: |
          yarn install --frozen-lockfile
          yarn build

      - name: Link plugin
        run: sf plugins link .

      - name: Verify plugin installation
        run: |
          sf plugins | grep @jterrats/profiler
          if [ $? -eq 0 ]; then
            echo "✓ Plugin linked successfully"
          else
            echo "✗ Plugin not found"
            exit 1
          fi

      - name: Test help commands
        run: |
          sf profiler --help
          sf profiler retrieve --help
          sf profiler compare --help

      - name: Unlink plugin
        run: sf plugins unlink @jterrats/profiler

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check TypeScript types
        run: yarn compile

      - name: Run linter
        run: yarn lint

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for unresolved TODOs and FIXMEs..."
          if grep -r "TODO\|FIXME" src/ test/ --exclude-dir=node_modules; then
            echo "⚠️  Found TODO/FIXME comments (non-blocking)"
          else
            echo "✓ No TODO/FIXME comments found"
          fi
        continue-on-error: true

      - name: Check file sizes
        run: |
          echo "Checking compiled file sizes..."
          du -sh lib/ || echo "lib directory not found"
          find lib -name "*.js" -exec du -h {} \; | sort -h | tail -5 || true

  security-check:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'yarn'

      - name: Run security audit
        run: yarn audit --groups dependencies
        continue-on-error: true

      - name: Check for outdated dependencies
        run: yarn outdated
        continue-on-error: true

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [test, test-plugin-linking, code-quality]
    if: always()

    steps:
      - name: Check build status
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests**: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Plugin Linking**: ${{ needs.test-plugin-linking.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Quality**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.test.result }}" == "success" ]] && [[ "${{ needs.test-plugin-linking.result }}" == "success" ]] && [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "✅ **All checks passed!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
          fi
